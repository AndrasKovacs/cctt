isEquiv (A B : U)(f : A → B) : U :=
    (g    : B → A)
  × (linv : (x : A) → x = g (f x))
  × (rinv : (x : B) → f (g x) = x)
  × ((x : A) → refl ={i. f (linv x i) = f x} (rinv (f x)));

equiv (A B : U) : U :=
  (f : A → B) × isEquiv A B f;

idEquiv (A : U) : equiv A A :=
  (λ x. x, λ x. x, λ x _. x, λ x _. x, λ x _ _. x);

ua (A B : U)(f : equiv A B) : A = B :=
  λ i. Glue B [i=0. (A, f); i=1. (B, idEquiv B)];

test (A B : U)(f : equiv A B)(x : A) : B := com 0 1 (ua A B f) [] x;

coeIsEquiv (A : I → U)(r r' : I) : isEquiv (A r) (A r') (λ x. coe r r' A x) :=
  let f'    (i : I)(x : A r)        : A i := coe r i A x;
  let g'    (i : I)(x : A i)        : A r := coe i r A x;
  let linv' (i : I)(x : A r)(j : I) : A r := hcom r i (A r) [j=0 k. x; j=1 k. coe k r A (coe r k A x)] x;
  let rinv' (i : I)(x : A i)(j : I) : A i := hcom i r (A i) [j=0 k. coe k i A (coe i k A x); j=1 k. x] x;

  ( λ x. g' r' x
  , λ x j. linv' r' x j
  , λ x j. rinv' r' x j
  , λ x l k. com r r' A
                      [k=0 i. f' i (linv' i x l)
                      ;k=1 i. f' i x
		      ;l=0 i. f' i x
		      ;l=1 i. rinv' i (f' i x) k]
		      x
  );

symDep (A B : U) (P : A = B) (a : A) (b : B) (p : a ={P} b) : b ={P⁻¹} a :=
  -- λ i. com 0 1 (j. hcom 0 j U [i=0. P; i=1 _. A] A)
  --              [i=0. p; i=1 _. a] a;


λ {b} {a} i. glue (hcom 0 1 A [i = 0 j. coe 1 0 P (coe j 1 P (p {a}
{b} j)); i = 1 _. coe 1 0 (_. A) (coe @1 1 (j. A) a); i = 0 i1. coe 1 0 P (coe
i1 1 P (p {a} {b} i1)); i = 1 i1. coe 1 0 (_. A) (coe i1 1 (j. A) a)] (hcom 1 0
A [i = 0 j. coe 1 0 P (coe 0 1 P a); i = 1 j. coe 1 0 (_. A) (coe 0 1 (j1. A)
a)] (hcom 0 1 A [i = 0 j. coe j 1 (j1. A) (coe j 0 P (coe 0 j P a)); i = 1
j. coe j 1 (j1. A) (coe j 0 (_. A) (coe 0 j (j1. A) a))] (coe 0 1 (j. A) a))))
[i = 0. B, λ x. coe 1 0 P x, λ x. coe 0 1 P x, λ x {x} {coe 0 1 P (coe 1 0 P x)}
j. hcom 1 0 B [j = 0 k. x; j = 1 k. coe k 1 P (coe 1 k P x)] x, λ x {coe 1 0 P
(coe 0 1 P x)} {x} j. hcom 0 1 A [j = 0 k. coe k 0 P (coe 0 k P x); j = 1 k. x]
x, λ x {λ {coe 1 0 P x} {coe 1 0 P x} _. coe 1 0 P x} {λ {coe 1 0 P (coe 0 1 P
(coe 1 0 P x))} {coe 1 0 P x} k. hcom 0 1 A [k = 0 k1. coe k1 0 P (coe 0 k1 P
(coe 1 0 P x)); k = 1 k1. coe 1 0 P x] (coe 1 0 P x)} l {coe 1 0 P (hcom 1 0 B
[l = 0 k. x; l = 1 k. coe k 1 P (coe 1 k P x)] x)} {coe 1 0 P x} k. hcom 1 0 A
[k = 0 i1. coe i1 0 P (coe 1 i1 P (hcom 1 i1 B [l = 0 k1. x; l = 1 k1. coe k1 1
P (coe 1 k1 P x)] x)); k = 1 i1. coe i1 0 P (coe 1 i1 P x); l = 0 i1. coe i1 0 P
(coe 1 i1 P x); l = 1 i1. coe i1 0 P (hcom i1 1 (P {A} {B} i1) [k = 0 k1. coe k1
i1 P (coe i1 k1 P (coe 1 i1 P x)); k = 1 k1. coe 1 i1 P x] (coe 1 i1 P x))] (coe
1 0 P x); i = 1. A, λ x. coe 1 0 (_. A) x, λ x. coe 0 1 (_. A) x, λ x {x} {coe 0
1 (_. A) (coe 1 0 (_. A) x)} j. hcom 1 0 A [j = 0 k. x; j = 1 k. coe k 1 (_. A)
(coe 1 k (_. A) x)] x, λ x {coe 1 0 (_. A) (coe 0 1 (_. A) x)} {x} j. hcom 0 1 A
[j = 0 k. coe k 0 (_. A) (coe 0 k (_. A) x); j = 1 k. x] x, λ x {λ {coe 1 0
(_. A) x} {coe 1 0 (_. A) x} _. coe 1 0 (_. A) x} {λ {coe 1 0 (_. A) (coe 0 1
(_. A) (coe 1 0 (_. A) x))} {coe 1 0 (_. A) x} k. hcom 0 1 A [k = 0 k1. coe k1 0
(_. A) (coe 0 k1 (_. A) (coe 1 0 (_. A) x)); k = 1 k1. coe 1 0 (_. A) x] (coe 1
0 (_. A) x)} l {coe 1 0 (_. A) (hcom 1 0 A [l = 0 k. x; l = 1 k. coe k 1 (_. A)
(coe 1 k (_. A) x)] x)} {coe 1 0 (_. A) x} k. hcom 1 0 A [k = 0 i1. coe i1 0
(_. A) (coe 1 i1 (_. A) (hcom 1 i1 A [l = 0 k1. x; l = 1 k1. coe k1 1 (_. A)
(coe 1 k1 (_. A) x)] x)); k = 1 i1. coe i1 0 (_. A) (coe 1 i1 (_. A) x); l = 0
i1. coe i1 0 (_. A) (coe 1 i1 (_. A) x); l = 1 i1. coe i1 0 (_. A) (hcom i1 1 A
[k = 0 k1. coe k1 i1 (_. A) (coe i1 k1 (_. A) (coe 1 i1 (_. A) x)); k = 1
k1. coe 1 i1 (_. A) x] (coe 1 i1 (_. A) x))] (coe 1 0 (_. A) x)] [i = 0. b; i =
1. a];

-- pathToEquiv (A B : U)(p : A = B) : equiv A B :=
--   ((λ x. coe 0 1 p x), coeIsEquiv (λ i. p i) 0 1);

-- uaTrip (A B : U)(f : equiv A B) : equiv A B :=
--   pathToEquiv A B (ua A B f);
